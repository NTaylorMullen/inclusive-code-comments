/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
class DomMeasurement{constructor(t=document){this._window=t.defaultView,this._document=t,this.clearCache()}_getElementCache(t){let e=this._elementCache.get(t);return e||(e={},this._elementCache.set(t,e)),e}clearCache(){this._documentVisibleBox=null,this._documentGap=null,this._documentScroll=null,this._elementCache=new Map}_contains(t,e){return t&&t!==e&&t.contains(e)}_getComputedStyle(t,e,o){let n,i;return"object"==typeof e?(n=e,i=""):(n=o,i=e),n.computedStyle||(n.computedStyle=new Map),n.computedStyle.has(i)||(n.computedStyle[i]=this._window.getComputedStyle(t,i||null)),n.computedStyle[i]}getComputedStyle(t,e=""){return this._getComputedStyle(t,e,this._getElementCache(t))}_getComputedStyleMap(t,e){return t.computedStyleMap?(e.computedStyleMap||(e.computedStyleMap=t.computedStyleMap()),e.computedStyleMap):null}getComputedStyleMap(t){return this._getComputedStyleMap(t,this._getElementCache(t))}getInlineStyle(t,e){return t.style.getPropertyValue(e)}getStyle(t,e,o=""){return this.getStyles(t,[e],o)[e]}getStyles(t,e,o=""){let n=null,i={};const s=this._getElementCache(t);for(const r of e)if(n=n||this._getComputedStyle(t,o,s),"line-height"===r||"lineHeight"===r)i[r]=this.getInlineStyle(t,r)||n[r]||"";else if("font"!==r||n[r])i[r]="zoom"===r?n[r]||"1":n[r]||"";else{const e=n["font-style"],o=n["font-variant"],s=n["font-weight"],l=n["font-size"],c=this.getInlineStyle(t,"line-height")||n["line-height"]||"",h=n["font-family"];i[r]=`${e} ${o} ${s} ${l} ${c?"/ "+c:""} ${h}`}return i}getExactStyle(t,e){return this.getExactStyles(t,[e])[e]}getExactStyles(t,e){const o=this._getElementCache(t),n=this._getComputedStyleMap(t,o);if(n){const t={};for(const o of e){const e=n.get(o);e?"number"==typeof(i=e).value&&"string"==typeof i.unit&&"number"!==i.unit?t[o]=e.value+e.unit:t[o]=e.toString():t[o]=""}return t}return this.getStyles(t,e);var i}setStyles(t,e,o=!1){Array.isArray(t)||(t=[t]);for(const n of t)for(const t in e){let i=e[t].trim();const s=o||DomMeasurement.IMPORTANT_REG_EXP.test(i);i=i.replace(DomMeasurement.IMPORTANT_REG_EXP,""),n.style.setProperty(t,i,s?"important":"")}}copyStyles(t,e,o,n=!1){const i=this.getStyles(t,o);this.setStyles(e,i,n)}resetStyles(t,e,o=!1){Array.isArray(t)||(t=[t]);let n="";for(const t in e){let i=e[t].trim();o&&!DomMeasurement.IMPORTANT_REG_EXP.test(i)&&(i+=" !important"),n+=`${t}: ${i};`}for(const e of t)e.style.cssText=n}removeStyle(t,e){Array.isArray(t)||(t=[t]),this.removeStyles(t,[e])}removeStyles(t,e){Array.isArray(t)||(t=[t]);for(const o of t)for(const t of e)o.style.removeProperty(t)}_getBoundingClientRect(t,e){return e.boundingClientRect||(e.boundingClientRect=clone(t.getBoundingClientRect())),e.boundingClientRect}_getBorderBox(t,e,o,n){const i="borderBox"+(e?"WithScroll":"")+(o?"WithScale":"");if(!n[i]){const s=this._getBoundingClientRect(t,n);let{top:r,left:l,width:c,height:h}=s;if(o){const e=this.getZoom(t);r*=e,l*=e,c*=e,h*=e}else{const e=this._getScaleFactor(t,n);c/=e.x,h/=e.y}if(e){const e=this.getDocumentScroll();if(r+=e.top,l+=e.left,this._document.body&&this._contains(this._document.body,t)){const t=this.getDocumentGap();r-=t.top,l-=t.left}}n[i]={top:r,right:l+c,bottom:r+h,left:l,width:c,height:h}}return n[i]}getBorderBox(t,e=!0,o=!0){return clone(this._getBorderBox(t,e,o,this._getElementCache(t)))}_getPaddingBox(t,e,o,n){const i="paddingBox"+(e?"WithScroll":"")+(o?"WithScale":"");if(!n[i]){let{top:s,left:r,width:l,height:c}=this._getBorderBox(t,e,o,n),h={x:1,y:1};o&&(h=this._getScaleFactor(t,n));const m=o?this._getZoom(t,n):1,d=this._getComputedStyle(t,n),a=(parseFloat(d["border-top-width"])||0)*h.y*m,u=(parseFloat(d["border-right-width"])||0)*h.x*m,g=(parseFloat(d["border-bottom-width"])||0)*h.y*m,p=(parseFloat(d["border-left-width"])||0)*h.x*m;let _=0,f=0;if("BackCompat"!==this._document.compatMode||t!==this._document.body||t!==this._document.scrollingElement){const e=t.clientWidth*h.x*m;f=c-a-t.clientHeight*h.y*m-g,(_=l-p-e-u)<1&&(_=0),f<1&&(f=0)}s+=a,r+=p,l=l-p-_-u,c=c-a-f-g,this._isRTL(t,n)&&(r+=_),n[i]={top:s,right:r+l,bottom:s+c,left:r,width:l,height:c,border:{top:a,right:u,bottom:g,left:p}}}return n[i]}getPaddingBox(t,e=!0,o=!0){return clone(this._getPaddingBox(t,e,o,this._getElementCache(t)))}_getContentBox(t,e,o,n){const i="contentBox"+(e?"WithScroll":"")+(o?"WithScale":"");if(!n[i]){let{top:s,left:r,width:l,height:c,border:h}=this._getPaddingBox(t,e,o,n),m={x:1,y:1};o&&(m=this._getScaleFactor(t,n));const d=o?this._getZoom(t,n):1,a=this._getComputedStyle(t,n),u=(parseFloat(a["padding-top"])||0)*m.y*d,g=(parseFloat(a["padding-right"])||0)*m.x*d,p=(parseFloat(a["padding-bottom"])||0)*m.y*d,_=(parseFloat(a["padding-left"])||0)*m.x*d;s+=u,r+=_,l=l-_-g,c=c-u-p,n[i]={top:s,right:r+l,bottom:s+c,left:r,width:l,height:c,border:h,padding:{top:u,right:g,bottom:p,left:_}}}return n[i]}getContentBox(t,e=!0,o=!0){return clone(this._getContentBox(t,e,o,this._getElementCache(t)))}_getScrollDimensions(t,e,o){const n="scrollDimensions"+(e?"WithScale":"");if(!o[n]){let i=t.scrollWidth,s=t.scrollHeight;if(e){const e=this._getScaleFactor(t,o),n=this._getZoom(t,o);i=i*e.x*n,s=s*e.y*n}o[n]={width:i,height:s}}return o[n]}getScrollDimensions(t,e=!0){return clone(this._getScrollDimensions(t,e,this._getElementCache(t)))}_getScrollPosition(t,e,o,n){const i="scrollPosition"+(e?"WithScale":"")+(o?"WithZoom":"");if(!n[i]){let s={x:1,y:1};e&&(s=this._getScaleFactor(t,n));const r=o?this._getZoom(t,n):1,l=t===this._document.body&&"BackCompat"===this._document.compatMode,c=l?0:t.scrollTop*s.y*r,h=l?0:t.scrollLeft*s.x*r;n[i]={top:c,left:h}}return n[i]}getScrollPosition(t,e=!0,o=e){return clone(this._getScrollPosition(t,e,o,this._getElementCache(t)))}getScaleFactor(t){return this._getScaleFactor(t,this._getElementCache(t))}_getScaleFactor(t,e){if(void 0===e.scaleFactor){if(t instanceof SVGElement){if(BrowserDetector.isFirefox())return{x:1,y:1};let e=1;const o=t.getAttribute("transform")||"",n=/scale\((\d+(\.\d+)?)\)/.exec(o);return n&&(e=+n[1]),{x:e,y:e}}{const o=this._getBoundingClientRect(t,e),n=t.offsetWidth,i=t.offsetHeight;e.scaleFactor={x:1,y:1},o.width>0&&n>0&&Math.abs(o.width-n)>1&&(e.scaleFactor.x=o.width/n),o.height>0&&i>0&&Math.abs(o.height-i)>1&&(e.scaleFactor.y=o.height/i)}}return e.scaleFactor}_getZoom(t,e){if(BrowserDetector.isFirefox())return 1;if("number"!=typeof e.zoom){let o=1,n=t;for(;n&&n!==this._document.documentElement;){o*=+this.getStyle(n,"zoom"),n=n.parentElement}e.zoom=o}return e.zoom}getZoom(t){return this._getZoom(t,this._getElementCache(t))}_getStackingContextWithZIndex(t){const e=this.getComputedStyle(t),o=parseInt(e.zIndex||"");if(isNaN(o))return null;if(e.position&&DomMeasurement.NON_STATIC_POSITIONS.indexOf(e.position)>-1)return{zIndex:o};if(t.parentElement){const e=this.getComputedStyle(t.parentElement);if("flex"===e.display||"grid"===e.display)return{zIndex:o}}return null}getZIndex(t,e=this._document.documentElement){let o="auto",n=t;if(!n.ownerDocument)return"auto";const i=n.ownerDocument.defaultView.Element;for(;n&&n!==this._document&&n!==e&&n instanceof i;){const t=this._getStackingContextWithZIndex(n);t&&(o=t.zIndex),n=n.parentElement}return o}_isRTL(t,e){return"boolean"!=typeof e.isRTL&&(e.isRTL="rtl"===this.getStyle(t,"direction")),e.isRTL}isRTL(t){return this._isRTL(t,this._getElementCache(t))}isStackingContext(t){const e=this.getComputedStyle(t);return!!(e.position&&DomMeasurement.NON_STATIC_POSITIONS.indexOf(e.position)>-1)||("none"!==e.transform||"none"!==e.filter||"none"!==e.clipPath||"none"!==e.perspective||Number(e.opacity)<1)}getTextBoundingBoxes(t,e,o=!0){Array.isArray(t)||(t=[t]);let n=[],i=0,s=0;if(o){const t=this.getDocumentScroll();if(i+=t.top,s+=t.left,this._document.body&&this._contains(this._document.body,e)){const t=this.getDocumentGap();i-=t.top,s-=t.left}}for(const e of t)try{const t=this._document.createRange();t.setStart(e.textNode,e.start),t.setEnd(e.textNode,e.end);const o=Array.from(t.getClientRects());for(const t of o){if(t.width<DomMeasurement.MIN_TEXT_BOX_WIDTH)continue;const e=n[n.length-1],o=t.top+i,r=t.right+s,l=t.bottom+i,c=t.left+s,h=t.width,m=t.height;e&&e.right===c&&e.top===o&&e.bottom===l&&e.height===m?(e.right=r,e.width=e.width+h):n.push({top:o,right:r,bottom:l,left:c,width:h,height:m})}}catch(t){}return n}getRelativeTextBoundingBoxes(t,e,o=this.getScrollPosition(e)){Array.isArray(t)||(t=[t]);let n=[];const i=this.getPaddingBox(e,!1,!1),s=i.left-o.left,r=i.top-o.top;let l=this._document.createRange();for(const e of t)try{l.setStart(e.textNode,e.start),l.setEnd(e.textNode,e.end);const t=Array.from(l.getClientRects());for(const e of t){if(e.width<DomMeasurement.MIN_TEXT_BOX_WIDTH)continue;const t=n[n.length-1],o=e.top-r,i=e.right-s,l=e.bottom-r,c=e.left-s,h=e.width,m=e.height;t&&t.right===c&&t.top===o&&t.bottom===l&&t.height===m?(t.right=i,t.width=t.width+h):n.push({top:o,right:i,bottom:l,left:c,width:h,height:m})}}catch(t){console.error("LT range error",t)}const c=this.getScaleFactor(e);for(const t of n)t.top=Math.round(t.top/c.y),t.right=Math.round(t.right/c.x),t.bottom=Math.round(t.bottom/c.y),t.left=Math.round(t.left/c.x),t.width=t.right-t.left,t.height=t.bottom-t.top;return n}getRelativeTextBoundingBox(t,e){const o=this.getRelativeTextBoundingBoxes(t,e),n=Math.min(...o.map(t=>t.top)),i=Math.max(...o.map(t=>t.right)),s=Math.max(...o.map(t=>t.bottom)),r=Math.min(...o.map(t=>t.left));return{top:n,right:i,bottom:s,left:r,width:i-r,height:s-n}}_hasRelativePosition(t,e){const o=this._getComputedStyle(t,e).position||"static";return DomMeasurement.NON_STATIC_POSITIONS.indexOf(o)>-1}getDocumentGap(){if(!this._documentGap&&(this._documentGap={top:0,left:0},this._document.body&&this._hasRelativePosition(this._document.body,this._getElementCache(this._document.body)))){const t=this.getBorderBox(this._document.documentElement),e=this.getBorderBox(this._document.body);let o=this._document.documentElement.offsetTop,n=this._document.documentElement.offsetLeft;if(BrowserDetector.isFirefox()){let t=null;0===o&&(t=this.getComputedStyle(this._document.documentElement),o=parseInt(t["margin-top"])||0),0===n&&(t=t||this.getComputedStyle(this._document.documentElement),n=parseInt(t["margin-left"])||0)}const i=e.top-t.top+o,s=e.left-t.left+n,r=this.getComputedStyle(this._document.body),l=parseFloat(r["border-top-width"])||0,c=parseFloat(r["border-left-width"])||0;this._documentGap={top:i+l,left:s+c}}return clone(this._documentGap)}getDocumentVisibleBox(){if(!this._documentVisibleBox){const t=this.getDocumentScroll(),e=this._document.documentElement.clientHeight,o=this._document.documentElement.clientWidth;this._documentVisibleBox={top:t.top,right:t.left+o,bottom:t.top+e,left:t.left,width:o,height:e}}return clone(this._documentVisibleBox)}getDocumentScroll(){if(!this._documentScroll){const t=this._document.documentElement&&this._document.documentElement.scrollTop||this._document.body&&this._document.body.scrollTop||0,e=this._document.documentElement&&this._document.documentElement.scrollLeft||this._document.body&&this._document.body.scrollLeft||0;this._documentScroll={top:t,left:e}}return clone(this._documentScroll)}}DomMeasurement.IMPORTANT_REG_EXP=/!important$/,DomMeasurement.NON_STATIC_POSITIONS=["relative","fixed","absolute","sticky"],DomMeasurement.MIN_TEXT_BOX_WIDTH=.1;